<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>لوحة التحكم - GoldPrice</title>

    <!-- Bootstrap RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f8fafc, #eef2f7);
        }

        /* Navbar */
        .navbar {
            background: #111827;
        }

        .navbar-brand {
            color: #fbbf24 !important;
            font-weight: 700;
            font-size: 20px;
        }

        /* Sidebar */
        .sidebar {
            background: #111827;
            min-height: 100vh;
            border-radius: 0 20px 20px 0;
            padding: 25px 15px;
        }

        .sidebar h5 {
            color: #fbbf24;
            margin-bottom: 20px;
        }

        .sidebar .nav-link {
            color: #cbd5e1;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 8px;
            transition: 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: #1f2937;
            color: #fbbf24;
        }

        /* Cards */
        .card {
            border: none;
            border-radius: 16px;
        }

        .card-stats {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #111;
        }

        .card-stats h3 {
            font-weight: 700;
        }

        /* Table */
        .table-wrap {
            background: white;
            border-radius: 16px;
            padding: 25px;
        }

        .table thead {
            background: #111827;
            color: white;
        }

        .table-hover tbody tr:hover {
            background: #f3f4f6;
        }

        /* Buttons */
        .btn-primary {
            background: #fbbf24;
            border: none;
            color: #111;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #f59e0b;
            color: #111;
        }

        .btn-outline-primary {
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .btn-outline-primary:hover {
            background: #fbbf24;
            color: #111;
        }

        /* Pagination */
        .pagination .page-item.active .page-link {
            background: #fbbf24;
            border-color: #fbbf24;
            color: #111;
        }

        .form-control:focus {
            border-color: #fbbf24;
            box-shadow: 0 0 0 0.2rem rgba(251, 191, 36, 0.25);
        }

        .shadow-soft {
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
    </style>
</head>

<body>

<nav class="navbar shadow-sm">
    <div class="container-fluid">
        <span class="navbar-brand">GoldPrice Admin</span>
        <span class="text-light small">لوحة تحكم احترافية</span>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">

        <!-- Sidebar -->
        <div class="col-lg-2 col-md-3 p-0">
            <aside class="sidebar">
                <h5>القائمة</h5>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">لوحة القيادة</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#users">المستخدمون</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/h2-console" target="_blank">قاعدة البيانات</a>
                    </li>
                </ul>

                <hr class="bg-light">

                <button class="btn btn-primary w-100 mt-3"
                        data-bs-toggle="modal"
                        data-bs-target="#sendModal"
                        onclick="openSendModalForBroadcast()">
                    إرسال رسالة للجميع
                </button>
            </aside>
        </div>

        <!-- Main Content -->
        <div class="col-lg-10 col-md-9 p-4">

            <!-- Stats -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card card-stats shadow-soft p-4">
                        <h6>إجمالي المستخدمين</h6>
                        <h3 th:text="${users.size()}">0</h3>
                        <small>عدد الحسابات المسجلة في النظام</small>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card shadow-soft p-4">
                        <div class="d-flex gap-2">
                            <input id="searchInput"
                                   class="form-control"
                                   placeholder="ابحث بواسطة Chat ID أو CFD"
                                   oninput="applyFilter()">

                            <select id="perPage"
                                    class="form-select"
                                    style="width:150px"
                                    onchange="applyPagination()">
                                <option value="5">5 / صفحة</option>
                                <option value="10" selected>10 / صفحة</option>
                                <option value="25">25 / صفحة</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <section id="users">
                <div class="table-wrap shadow-soft">
                    <h5 class="mb-4">قائمة المستخدمين</h5>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="userTable">
                            <thead>
                            <tr>
                                <th>Chat ID</th>
                                <th>Last Sent CFD</th>
                                <th>إجراءات</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="u : ${users}">
                                <td th:text="${u.chatId}"></td>
                                <td th:text="${u.lastSentCfd}"></td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary"
                                                onclick="openSendModal(this)"
                                                th:attr="data-chatid=${u.chatId}">
                                            إرسال رسالة
                                        </button>

                                        <form th:action="@{/admin/send}" method="post">
                                            <input type="hidden" name="chatId" th:value="${u.chatId}">
                                            <input type="hidden" name="message" value="آخر سعر تم إرساله">
                                            <button class="btn btn-sm btn-outline-success" type="submit">
                                                إرسال آخر سعر
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <nav class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination"></ul>
                    </nav>
                </div>
            </section>

        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="sendModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="/admin/send" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">إرسال رسالة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Chat ID</label>
                        <input type="text" name="chatId" id="modalChatId" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">الرسالة</label>
                        <textarea name="message" id="modalMessage" rows="5" class="form-control"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">إرسال</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let currentPage = 1;
    let perPage = 10;
    let rows = [];

    function initPagination() {
        rows = Array.from(document.querySelectorAll('#userTable tbody tr'));
        applyPagination();
    }

    function applyFilter() {
        currentPage = 1;
        applyPagination();
    }

    function applyPagination() {
        perPage = parseInt(document.getElementById('perPage').value);
        const query = document.getElementById('searchInput').value.trim();

        const filtered = rows.filter(r => {
            if (!query) return true;
            return r.innerText.includes(query);
        });

        const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
        if (currentPage > totalPages) currentPage = totalPages;

        rows.forEach(r => r.style.display = 'none');

        filtered.slice((currentPage - 1) * perPage, currentPage * perPage)
            .forEach(r => r.style.display = '');

        renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
        const container = document.getElementById('pagination');
        container.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = 'page-item ' + (i === currentPage ? 'active' : '');
            const a = document.createElement('a');
            a.className = 'page-link';
            a.innerText = i;
            a.onclick = () => { currentPage = i; applyPagination(); };
            li.appendChild(a);
            container.appendChild(li);
        }
    }

    function openSendModal(btn) {
        document.getElementById('modalChatId').value = btn.getAttribute('data-chatid') || '';
        new bootstrap.Modal(document.getElementById('sendModal')).show();
    }

    function openSendModalForBroadcast() {
        document.getElementById('modalChatId').value = '';
        document.getElementById('modalMessage').value = '';
        new bootstrap.Modal(document.getElementById('sendModal')).show();
    }

    document.addEventListener('DOMContentLoaded', initPagination);
</script>

</body>
</html>
